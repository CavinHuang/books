
# åŸºç¡€ç¯‡-é‰´æƒä¸ç™»å½•
---

## å‰è¨€

ç»Ÿä¸€çš„ç”¨æˆ·ä¸­å¿ƒä½œä¸ºåŸºç¡€æœåŠ¡ï¼Œä¸ºäº†æ–¹ä¾¿å›¢é˜ŸåŒå­¦ä½¿ç”¨ï¼Œä¸€èˆ¬ä¼šå°† **OA** ç³»ç»Ÿã€é’‰é’‰ã€é£ä¹¦ã€ä¼ä¸šå¾®ä¿¡ç­‰ç­‰å„ç§ç¬¬ä¸‰æ–¹å¸¸ç”¨æœåŠ¡çš„ç”¨æˆ·æ•°æ®æ‰“é€šï¼Œä½¿å¾—å›¢é˜Ÿæˆå‘˜å¯ä»¥å¿«é€Ÿç™»å½•ã€‚

åœ¨ [DevOps å°å†Œ](https://juejin.cn/book/6948353204648148995)ä¸­ï¼Œä½¿ç”¨äº† `GitLab` ä½œä¸ºä¸‰æ–¹åº”ç”¨æˆæƒï¼Œé¿å…ç”¨æˆ·é‡å¤ç™»å½•ï¼Œé£ä¹¦ä¹Ÿæä¾›äº†ä¸€æ ·çš„ä¸‰æ–¹æˆæƒèƒ½åŠ›ã€‚

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ ä½¿ç”¨ `NestJS` çš„å®ˆå«æ¨¡å—ç»“åˆä¹‹å‰å°è£…è¿‡çš„é£ä¹¦**ç”¨æˆ·æ¨¡å—**è¿›è¡Œä¸‰æ–¹æˆæƒç™»å½•ï¼Œå¹¶ä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œä¸ºç”¨æˆ·ç³»ç»Ÿçš„ä¸šåŠ¡å¼€å‘åšå®Œæœ€åä¸€æ­¥çš„å‡†å¤‡å·¥ä½œã€‚

## é£ä¹¦å¯¹æ¥

é£ä¹¦åº”ç”¨ç¬¬ä¸‰æ–¹ç½‘ç«™å…ç™»çš„æ­¥éª¤å¦‚ä¸‹ã€‚

1.  ç½‘é¡µåç«¯å‘ç°ç”¨æˆ·æœªç™»å½•ï¼Œ[è¯·æ±‚èº«ä»½éªŒè¯](https://open.feishu.cn/document/ukTMukTMukTM/ukzN4UjL5cDO14SO3gTN)ï¼›
2.  ç”¨æˆ·ç™»å½•åï¼Œå¼€æ”¾å¹³å°ç”Ÿæˆç™»å½•é¢„æˆæƒç ï¼Œ302è·³è½¬è‡³é‡å®šå‘åœ°å€ã€‚
3.  ç½‘é¡µåç«¯è°ƒç”¨[è·å–ç™»å½•ç”¨æˆ·èº«ä»½](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/authen-v1/authen/access_token)æ ¡éªŒç™»å½•é¢„æˆæƒç åˆæ³•æ€§ï¼Œè·å–åˆ°ç”¨æˆ·èº«ä»½ã€‚
4.  å¦‚éœ€å…¶ä»–ç”¨æˆ·ä¿¡æ¯ï¼Œç½‘é¡µåç«¯å¯è°ƒç”¨[è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆèº«ä»½éªŒè¯ï¼‰](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/authen-v1/authen/user_info)ã€‚

æˆæƒæµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0fff3a5fc92c432ea5aa09cf3a392c74~tplv-k3u1fbpfcp-watermark.image?)

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŒ‰ç…§æ­¥éª¤é€æ­¥å®ç°é£ä¹¦çš„ä¸‰æ–¹æˆæƒ

#### è¯·æ±‚ç”¨æˆ·èº«ä»½éªŒè¯

**ç¬¬ä¸€æ­¥**ï¼šå¼€å¯ç½‘é¡µèƒ½åŠ›å¹¶é…ç½®é‡å®šå‘é“¾æ¥ã€‚

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d66663a5eba541b08f55a711c23449ce~tplv-k3u1fbpfcp-watermark.image?)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç‚¹å‡»ç½‘é¡µèœå•å¼€å¯ç½‘é¡µèƒ½åŠ›ä¹‹åï¼Œåœ¨å®‰å…¨è®¾ç½®èœå•ä¸­ï¼Œæ·»åŠ å›è°ƒ URL åœ°å€ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ `http://127.0.0.1:8080/auth`ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„å–œå¥½æ¥è®¾å®šã€‚

**ç¬¬äºŒæ­¥**ï¼šè¯·æ±‚ç”¨æˆ·èº«ä»½éªŒè¯ã€‚

æ ¹æ®é£ä¹¦çš„æ–‡æ¡£ç»„è£…èº«ä»½éªŒè¯è¯·æ±‚æ¥å£ï¼š`https://open.feishu.cn/open-apis/authen/v1/index?redirect_uri={REDIRECT_URI}&app_id={APPID}&state={STATE}` ï¼Œå‚æ•°è¯´æ˜å¦‚ä¸‹æ‰€ç¤ºï¼š

| å‚æ•° | ç±»å‹ | å¿…é¡» | è¯´æ˜ |
| --- | --- | --- | --- |
| redirect\_uri | string | æ˜¯ | é‡å®šå‘ `URL`ï¼ˆä½¿ç”¨ç¬¬ä¸€æ­¥é…ç½®çš„é‡å®šå‘ `URL` å³å¯ï¼‰ |
| app\_id | string | æ˜¯ | å›ºå®šçš„åº”ç”¨æ ‡è¯†ï¼Œåœ¨åº”ç”¨åå°ã€å‡­è¯å’ŒåŸºç¡€ä¿¡æ¯ã€‘ä¸­å¯è§ |
| state | string | å¦ | ç”¨æ¥ç»´æŠ¤è¯·æ±‚å’Œå›è°ƒçŠ¶æ€çš„é™„åŠ å­—ç¬¦ä¸²ï¼Œ åœ¨æˆæƒå®Œæˆå›è°ƒæ—¶ä¼šé™„åŠ æ­¤å‚æ•°ï¼Œåº”ç”¨å¯ä»¥æ ¹æ®æ­¤å­—ç¬¦ä¸²æ¥åˆ¤æ–­ä¸Šä¸‹æ–‡å…³ç³» |

æ‰€ä»¥å¯¹äºæˆ‘ä»¬çš„åº”ç”¨ï¼Œè¯·æ±‚èº«ä»½çš„é“¾æ¥ä¸ºï¼š`https://open.feishu.cn/open-apis/authen/v1/index?app_id=cli_xxxxxxd&redirect_uri=http%3A%2F%2F127.0.0.1%3A8080%2Fauth`ï¼Œåœ¨æµè§ˆå™¨ç›´æ¥è¾“å…¥æ­¤é“¾æ¥å¦‚æœå‡ºç°å¦‚ä¸‹çš„é£ä¹¦æˆæƒç•Œé¢ï¼Œåˆ™ä»£è¡¨æˆ‘ä»¬å·²ç»æ­£å¸¸é…ç½®æˆåŠŸäº†ï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/24e4a3045ab94e42a991f28f82ecff48~tplv-k3u1fbpfcp-watermark.image?)

**ç¬¬ä¸‰æ­¥**ï¼šè·å–ç™»å½•é¢„æˆæƒç ã€‚è¿™ä¸€æ­¥æ¯”è¾ƒç®€å•ï¼Œæ­£å¸¸å‡ºç°é£ä¹¦åº”ç”¨æˆæƒçš„ç•Œé¢ä¹‹åï¼Œç‚¹å‡»æˆæƒã€**æŒ‰é’®**ã€‘å³å¯è·å–åˆ°å¯¹åº”çš„ç™»å½•é¢„æˆæƒç ã€‚

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5a69e15e58894e7e92d06c26cf58861b~tplv-k3u1fbpfcp-watermark.image?)

å‡ºç°ä¸Šå›¾çš„ç•Œé¢å¹¶ä¸æ„å¤–ï¼Œæ¯•ç«Ÿè¿™ä¸ªé“¾æ¥æ˜¯éšä¾¿å¡«å†™çš„ï¼Œé£ä¹¦å¹¶ä¸ä¼šçœŸçš„å»æ ¡éªŒè¿™ä¸ªé“¾æ¥æ˜¯å¦çœŸå®å­˜åœ¨ã€‚å½“æˆ‘ä»¬ç‚¹å‡»æˆæƒä¹‹åï¼Œå®ƒä¼šå°†ç™»å½•é¢„æˆæƒç æ”¾åœ¨é‡å®šå‘ `URL` çš„ `code` å‚æ•°ä¸­ç›´æ¥è½¬å‘ï¼Œæ‰€ä»¥å³ä½¿è¿™ä¸ªè¯·æ±‚æ˜¯å‡çš„ï¼Œä¹Ÿèƒ½é¡ºåˆ©æ‹¿åˆ°å¯¹åº”çš„ `code`ã€‚

**ç¬¬å››æ­¥**ï¼šè·å–ç”¨æˆ·å‡­è¯ã€‚åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œä½¿ç”¨ç¬¬ä¸‰æ­¥è·å–åˆ°çš„ç™»å½•é¢„æˆæƒç ï¼Œä¹Ÿå°±æ˜¯é‡å®šå‘ `URL Query` å‚æ•°ä¸­çš„ `code` å‘é£ä¹¦æ¢å–çœŸæ­£çš„ç”¨æˆ·å‡­è¯ï¼Œæ³¨æ„ `code` çš„æœ‰æ•ˆæœŸåªæœ‰ **5** åˆ†é’Ÿï¼Œä¸”åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œè¿‡æœŸæˆ–å·²ä½¿ç”¨çš„ `code` éƒ½æ— æ³•å†æ¬¡æ¢å–çœŸå®ç”¨æˆ·å‡­è¯ã€‚

 1.     åœ¨ `src/helper/feishu/auth.ts` ä¸­æ·»åŠ æ–°çš„æ¢å–ç”¨æˆ·å‡­è¯æ–¹æ³•ï¼š

```ts
export const getUserToken = async ({ code, app_token }) => {
  const { data } = await methodV({
    url: `/authen/v1/access_token`,
    method: 'POST',
    headers: {
      Authorization: `Bearer ${app_token}`,
    },
    params: {
      grant_type: 'authorization_code',
      code,
    },
  });
  return data;
};
```

 2.     åœ¨ `src/user/feishu/feishu.service.ts` ä¸­æ·»åŠ æ–°çš„æ¢å–ç”¨æˆ·å‡­è¯çš„ `Service`ï¼š

```ts
async getUserToken(code: string) {
    const app_token = await this.getAppToken()
    const dto: GetUserTokenDto = {
      code,
      app_token
    };
    const res: any = await getUserToken(dto);
    if (res.code !== 0) {
      throw new BusinessException(res.msg);
    }
    return res.data;
}
```

 3.     åœ¨ `src/user/feishu/feishu.controller.ts` ä¸­æ·»åŠ æ–°çš„æ¢å–ç”¨æˆ·å‡­è¯çš„ `Controller`ï¼š

```ts
  @Public()
  @ApiOperation({
    summary: 'è·å–ç”¨æˆ·å‡­è¯',
  })
  @Post('getUserToken')
  getUserToken(@Body() params: GetUserTokenDto) {
    const { code } = params
    return this.feishuService.getUserToken(code);
  }
```

æ‰“å¼€ **Swagger** è°ƒè¯• `getUserToken` æ¥å£ï¼Œå°†ç¬¬ä¸‰æ­¥è·å–çš„ä¸´æ—¶ç™»å½•å‡­è¯è¾“å…¥å‚æ•°è°ƒè¯•ã€‚å¦‚æœé…ç½®æ­£å¸¸çš„è¯ï¼Œæ­¤æ—¶å¯ä»¥æ‹¿åˆ°é£ä¹¦çš„ç”¨æˆ·ä¿¡æ¯å’ŒçœŸå®çš„ç”¨æˆ·å‡­è¯ `access_token`ï¼Œä»¥åŠ `refresh_token` ç­‰å›è°ƒå€¼ã€‚

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aa7ca11c948648cd86c7bd3b66e61925~tplv-k3u1fbpfcp-watermark.image?)

ä¹‹åå¯ä»¥å°† `access_token` çš„å€¼ç¼“å­˜èµ·æ¥ï¼Œä½¿ç”¨ `access_token` è°ƒç”¨é£ä¹¦æä¾›çš„ä»»æ„æ¥å£ï¼Œä½†å‰ææ˜¯è¿™ä¸ªåº”ç”¨æ‹¥æœ‰å¯¹åº”çš„æ¨¡å—æ¥å£æƒé™æ‰èƒ½å¤Ÿæ­£å¸¸è°ƒç”¨ã€‚

**ç¬¬äº”æ­¥**: åˆ·æ–°ç”¨æˆ·å‡­è¯ã€‚å®‰å…¨èµ·è§ï¼Œé£ä¹¦è·å–çš„ `access_token` å’Œ `refresh_token` å‡å­˜åœ¨æœ‰æ•ˆæœŸã€‚`access_token` çš„æœ‰æ•ˆæœŸä¸º **2** å°æ—¶ï¼Œè¿‡æœŸä¹‹å‰å¯ä»¥é€šè¿‡æœ‰æ•ˆæœŸæ›´é•¿çš„ `refresh_token` ç¼“å­˜æ–°çš„ `access_token`ï¼Œæ¥ä¿è¯èƒ½å¤Ÿæ­£å¸¸è°ƒç”¨é£ä¹¦æ¥å£ã€‚

 1.     åœ¨Â `src/helper/feishu/auth.ts`Â ä¸­æ–°å¢åˆ·æ–°ç”¨æˆ· `access_token` æ–¹æ³•ï¼š

```ts
export const refreshUserToken = async ({ refreshToken, app_token }) => {
  const { data } = await methodV({
    url: `/authen/v1/refresh_access_token`,
    method: 'POST',
    headers: {
      Authorization: `Bearer ${app_token}`,
    },
    params: {
      grant_type: 'refresh_token',
      refresh_token: refreshToken,
      app_token,
    },
  });
  return data;
};
```

 2.     åœ¨ `src/user/feishu/feishu.service.ts` ä¸­æ·»åŠ **åˆ·æ–°**ã€**å­˜å‚¨**ã€**è¯»å–** `access_token` çš„ `Service`ï¼š

```ts
  async setUserCacheToken(tokenInfo: any) {
    const {
      refresh_token,
      access_token,
      user_id,
      expires_in,
      refresh_expires_in,
    } = tokenInfo;

    // ç¼“å­˜ç”¨æˆ·çš„ token
    await this.cacheManager.set(`${this.USER_TOKEN_CACHE_KEY}_${user_id}`, access_token, {
      ttl: expires_in - 60,
    });

    // ç¼“å­˜ç”¨æˆ·çš„ fresh token
    await this.cacheManager.set(
      `${this.USER_TOKEN_CACHE_KEY}_${user_id}`,
      refresh_token,
      {
        ttl: refresh_expires_in - 60,
      },
    );
  }

  async getCachedUserToken(userId: string) {
    let userToken: string = await this.cacheManager.get(
       `${this.USER_TOKEN_CACHE_KEY}_${userId}`,
    );

    // å¦‚æœ token å¤±æ•ˆ
    if (!userToken) {
      const refreshToken: string = await this.cacheManager.get(
        `${this.USER_TOKEN_CACHE_KEY}_${userId}`,
      );
      if (!refreshToken) {
        throw new BusinessException({
          code: BUSINESS_ERROR_CODE.TOKEN_INVALID,
          message: 'token å·²å¤±æ•ˆ',
        });
      }
      // è·å–æ–°çš„ç”¨æˆ· token
      const usrTokenInfo = await this.getUserTokenByRefreshToken(refreshToken);
      // æ›´æ–°ç¼“å­˜çš„ç”¨æˆ· token
      await this.setUserCacheToken(usrTokenInfo);
      userToken = usrTokenInfo.access_token;
    }
    return userToken;
  }

  async getUserTokenByRefreshToken(refreshToken: string) {
    return await refreshUserToken({
      refreshToken,
      app_token: await this.getAppToken(),
    });
  }
```

æ ¹æ®æ–¹æ³•åå¯ä»¥æ¸…æ™°åœ°çŸ¥é“å¯¹åº”çš„åŠŸèƒ½ï¼Œæˆ‘å°±ä¸è¿‡å¤šä»‹ç»äº†ã€‚è‡³æ­¤ï¼Œé£ä¹¦åº”ç”¨çš„ä¸‰æ–¹æˆæƒæ¨¡å—å¯¹æ¥å®Œæ¯•ã€‚

## é‰´æƒä¸ç™»å½•

ä¸Šè¿°æ­¥éª¤åªæ˜¯å¯¹æ¥äº†é£ä¹¦åº”ç”¨ï¼Œè¿˜ä¸è¶³å¤Ÿå®Œæˆç™»å½•æ€ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦å€ŸåŠ© `NestJS` æä¾›çš„ `Guards` æ¨¡å—ã€`Passport` ä¸ `JWT` æ¥å®Œæˆç™»å½•æ¨¡å—çš„å¼€å‘ã€‚

é¦–é€‰éœ€è¦å®‰è£…å¯¹åº”çš„ä¾èµ–ï¼š

```shell
$ yarn add @nestjs/passport passport
$ yarn add -D @types/passport-local
$ yarn add @nestjs/jwt passport-jwt
$ yarn add fastify-cookie
```

**ç¬¬ä¸€æ­¥**ï¼šæ–°å»º `auth.service.ts`ã€‚

```ts
import { Injectable } from '@nestjs/common';

import { JwtService } from '@nestjs/jwt';
import { FeishuUserInfo } from 'src/user/feishu/feishu.dto';
import { FeishuService } from 'src/user/feishu/feishu.service';
import { User } from '@/user/user.mongo.entity';
import { UserService } from 'src/user/user.service';

@Injectable()
export class AuthService {
  constructor(
    private jwtService: JwtService,
    private userService: UserService,
    private feishuService: FeishuService,
  ) { }

  // éªŒè¯é£ä¹¦ç”¨æˆ· 
  async validateFeishuUser(code: string): Promise<Payload> {
    const feishuInfo: FeishuUserInfo = await this.getFeishuTokenByApplications(
      code,
    );

    // å°†é£ä¹¦çš„ç”¨æˆ·ä¿¡æ¯åŒæ­¥åˆ°æ•°æ®åº“
    const user: User = await this.userService.createOrUpdateByFeishu(
      feishuInfo,
    );

    return {
      userId: user.id,
      username: user.username,
      name: user.name,
      email: user.email,
      feishuAccessToken: feishuInfo.accessToken,
      feishuUserId: feishuInfo.feishuUserId,
    };
  }

// jwt ç™»å½•
  async login(user: Payload) {
    return {
      access_token: this.jwtService.sign(user),
    };
  }

// è·å–é£ä¹¦ç”¨æˆ·ä¿¡æ¯
  async getFeishuTokenByApplications(code: string) {
    const data = await this.feishuService.getUserToken(code);
    const feishuInfo: FeishuUserInfo = {
      accessToken: data.access_token,
      avatarBig: data.avatar_big,
      avatarMiddle: data.avatar_middle,
      avatarThumb: data.avatar_thumb,
      avatarUrl: data.avatar_url,
      email: data.email,
      enName: data.en_name,
      mobile: data.mobile,
      name: data.name,
      feishuUnionId: data.union_id,
      feishuUserId: data.user_id,
    };
    return feishuInfo;
  }
}
```

ä¸Šè¿°ä»£ç ä¸­åˆ†ä¸ºä¸¤ä¸ªæ¨¡å—ï¼Œä¸€ä¸ªæ˜¯è·å–é£ä¹¦ç”¨æˆ·ä¿¡æ¯ä»¥åŠå¯¹è·å–åˆ°çš„ç”¨æˆ·ä¿¡æ¯æœ¬åœ°è½åº“ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯è°ƒç”¨ `jwtService` è¿›è¡Œç™»å½•ã€‚

**ç¬¬äºŒæ­¥**ï¼šæ–°å»º `/src/auth/strategies` ç›®å½•ï¼Œæ·»åŠ  `feishu-auth.strategy.ts` ä¸ `jwt-auth.strategy.ts` ä¸¤ä¸ªæ–‡ä»¶ï¼š

```ts
// feishu-auth.strategy.ts
import { PassportStrategy } from '@nestjs/passport';
import { Injectable, Query, UnauthorizedException } from '@nestjs/common';
import { AuthService } from '../auth.service';
import { Strategy } from 'passport-custom';
import { FastifyRequest } from 'fastify'

@Injectable()
export class FeishuStrategy extends PassportStrategy(Strategy, 'feishu') {
  constructor(private authService: AuthService) {
    super();
  }

  async validate(req: FastifyRequest): Promise<Payload> {
    const q: any = req.query;

    const user = await this.authService.validateFeishuUser(q.code as string);

    if (!user) {
      throw new UnauthorizedException();
    }

    return user;
  }
}
```

```ts
// jwt-auth.strategy.ts
import { Injectable } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';
import { Strategy } from 'passport-jwt';
import { jwtConstants } from '../constants';

import { FastifyRequest } from "fastify";

const cookieExtractor = function (req: FastifyRequest) {
  let token = null;
  if (req && req.cookies) {
    token = req.cookies['jwt'];
  }
  return token;
};

@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
  constructor() {
    super({
      jwtFromRequest: cookieExtractor,
      ignoreExpiration: jwtConstants.ignoreExpiration,
      secretOrKey: jwtConstants.secret,
    });
  }

  async validate(payload: Payload): Promise<Payload> {
    return { ...payload };
  }
}
```

`FeishuStrategy` æ ¹æ® `passport` æä¾›çš„æ–¹æ³•ï¼Œè‡ªå®šä¹‰äº†é£ä¹¦çš„ä¸“å±ç­–ç•¥ï¼Œè°ƒç”¨ `authService` ä¸­çš„ `validateFeishuUser` æ–¹æ³•ï¼Œä»é£ä¹¦è·å–å¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯ã€‚`JwtStrategy` åˆ™æ˜¯ä½¿ç”¨ `passport-jwt`æ‹“å±•çš„åŠŸèƒ½ï¼Œå¯¹ `cookie` åšäº†æ‹¦æˆªã€è§£å¯†ç­‰åŠŸèƒ½ã€‚

æ³¨æ„æ— è®ºæ˜¯ä½¿ç”¨ `passport` è‡ªå¸¦çš„ä¸‰æ–¹åŠŸèƒ½æˆ–è€…è‡ªè¡Œæ‹“å±• `passport`ï¼Œéƒ½éœ€è¦å¯¹ `validate` æ–¹æ³•è¿›è¡Œé‡å†™ä»¥ä¾¿å®ç°è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ã€‚

**ç¬¬ä¸‰æ­¥**ï¼šæ–°å»º `/src/auth/guards` ç›®å½•ï¼Œæ·»åŠ  `feishu-auth.guard.ts` ä¸ `jwt-auth.guard.ts` ä¸¤ä¸ªæ–‡ä»¶ï¼š

```ts
// feishu-auth.guard.ts
import { Injectable } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class FeishuAuthGuard extends AuthGuard('feishu') { }
```

è¿™é‡Œè¦**æ³¨æ„**ï¼Œå› ä¸º `FeishuAuthGuard` å·²ç»ç»§æ‰¿äº†é€šç”¨çš„ `AuthGuard`ï¼ŒéªŒè¯é€»è¾‘åœ¨ `FeishuStrategy` å®ç°äº†ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰é¢å¤–çš„ä»£ç å‡ºç°ï¼Œå¦‚æœæœ‰å…¶ä»–çš„é€»è¾‘åˆ™éœ€è¦å¯¹ä¸åŒçš„æ–¹æ³•è¿›è¡Œé‡å†™å·²å®Œæˆéœ€æ±‚ã€‚

```ts
// jwt-auth.guard.ts
import { ExecutionContext, Injectable } from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { AuthGuard } from '@nestjs/passport';
import { BUSINESS_ERROR_CODE } from '@/common/exceptions/business.error.codes';
import { BusinessException } from '@/common/exceptions/business.exception';
import { IS_PUBLIC_KEY } from '../constants';

@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') {
  constructor(private reflector: Reflector) {
    super();
  }

  canActivate(context: ExecutionContext) {
    const loginAuth = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [
      context.getHandler(),
      context.getClass(),
    ]);

    if (loginAuth) {
      return true;
    }

    return super.canActivate(context);
  }

  handleRequest(err, user, info) {
    if (err || !user) {
      throw (
        err ||
        new BusinessException({
          code: BUSINESS_ERROR_CODE.TOKEN_INVALID,
          message: 'token å·²å¤±æ•ˆ',
        })
      );
    }
    return user;
  }
}
```

`JwtAuthGuard` æ¨¡å—å®ç°äº† `canActivate` ä¸ `handleRequest` çš„é‡å†™ï¼Œåˆ†åˆ«æ˜¯é’ˆå¯¹äºè‡ªå®šä¹‰é€»è¾‘ä¸å¼‚å¸¸æ•è·çš„å¤„ç†ã€‚

å› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº† `JwtAuthGuard` ä½œä¸ºå…¨å±€éªŒè¯ï¼Œä½†æœ‰çš„æ—¶å€™ä¹Ÿæ˜¯éœ€è¦é’ˆå¯¹äºéƒ¨åˆ†æ¥å£å¼€å¯ç™½åå•ã€‚ä¾‹å¦‚ï¼Œç™»å½•æ¥å£å°±éœ€è¦å¼€å¯ç™½åå•ï¼Œæ¯•ç«ŸæŠŠç™»å½•æ¥å£ä¹Ÿæ‹¦æˆªäº†ï¼Œæ•´ä¸ªé¡¹ç›®å°±æ— æ³•æ­£å¸¸ä½¿ç”¨äº†ã€‚

**ç¬¬å››æ­¥**ï¼šåœ¨**ç¬¬äºŒæ­¥**ä¸­ï¼Œ`FeishuStrategy` å°†è·å–åˆ°çš„é£ä¹¦ç”¨æˆ·ä¿¡æ¯è¿”å›å‡ºæ¥ï¼Œè¢«è·¯ç”±å®ˆå«æŒ‚è½½åˆ° `request` ä¸Šï¼Œç”¨æˆ·ä¿¡æ¯é‡Œé¢çš„å†…å®¹ä¼šåœ¨åæœŸé¢‘ç¹ä½¿ç”¨åˆ°ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªç”¨æˆ·çš„è£…é¥°å™¨ `PayloadUser`ï¼Œæ–¹ä¾¿åæœŸä½¿ç”¨ã€‚

```ts
export const PayloadUser = createParamDecorator(
  (data, ctx: ExecutionContext): Payload => {
    const request = ctx.switchToHttp().getRequest();
    return request.user;
  },
);
```

**ç¬¬äº”æ­¥**ï¼šæ–°å»º `src/auth/auth.controller.ts`ã€‚

```ts
import {
  Controller,
  Post,
  UseGuards,
  Body,
  Res,
  Get,
  Query,
  Req,
  Response
} from '@nestjs/common';

import { FeishuAuthGuard } from './guards/feishu-auth.guard';
import { AuthService } from './auth.service';
import { ApiOperation, ApiTags } from '@nestjs/swagger';
import { GetTokenByApplications, LoginDto } from './auth.dto';
import { Public } from './constants';
import { PayloadUser } from '@/helper';
import { FeishuService } from 'src/user/feishu/feishu.service';
import { FastifyReply } from 'fastify'

@ApiTags('ç”¨æˆ·è®¤è¯')
@Controller('auth')
export class AuthController {
  constructor(
    private authService: AuthService,
    private readonly feishuService: FeishuService,
  ) { }

  @ApiOperation({
    summary: 'é£ä¹¦ Auth2 æˆæƒç™»å½•',
    description: 'é€šè¿‡ code è·å–`access_token`https://open.feishu.cn/open-apis/authen/v1/index?app_id=cli_xxxxxx&redirect_uri=http%3A%2F%2F127.0.0.1%3A8080%2Fauth',
  })
  @UseGuards(FeishuAuthGuard)
  @Public()
  @Get('/feishu/auth2')
  async getFeishuTokenByApplications(
    @PayloadUser() user: Payload,
    @Res({ passthrough: true }) response: FastifyReply,
    @Query() query: GetTokenByApplications,
  ) {
    const { access_token } = await this.authService.login(user);
    response.setCookie('jwt', access_token);
    return access_token
  }

  @ApiOperation({
    summary: 'è§£æ token',
    description: 'è§£æ token ä¿¡æ¯',
  })
  @Get('/token/info')
  async getTokenInfo(@PayloadUser() user: Payload) {
    return user;
  }
}
```

åœ¨ `getFeishuTokenByApplications` æ–¹æ³•ä¸­æˆ‘ä»¬ä½¿ç”¨äº† `@UseGuards(FeishuAuthGuard)` ä¸ `@Public()` ä¸¤ä¸ªè£…é¥°å™¨ï¼Œåˆ†åˆ«æ˜¯é£ä¹¦åº”ç”¨æˆæƒæ‹¦æˆªä¸å¼€å¯æ¥å£ç™½åå•ã€‚

åœ¨ç»è¿‡äº† `@UseGuards(FeishuAuthGuard)` ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨ `@PayloadUser` è·å–åˆ°çš„é£ä¹¦ç”¨æˆ·ä¿¡æ¯ï¼Œå†å°†ç”¨æˆ·ä¿¡æ¯è¿›è¡Œ `JWT` æ³¨å†Œã€‚

ç¬¬å…­æ­¥ï¼šæ–°å»º `/src/auth/auth.module.ts`ã€‚

```ts
import { Module } from '@nestjs/common';
import { UserModule } from 'src/user/user.module';
import { AuthService } from './auth.service';
import { JwtStrategy } from './strategies/jwt.strategy';
import { PassportModule } from '@nestjs/passport';

import { JwtModule } from '@nestjs/jwt';
import { jwtConstants } from './constants';
import { AuthController } from './auth.controller';
import { FeishuStrategy } from './strategies/feishu.strategy';

@Module({
  imports: [
    UserModule,
    PassportModule,
    JwtModule.register({
      secret: jwtConstants.secret,
      signOptions: { expiresIn: jwtConstants.expiresIn },
    }),
  ],
  controllers: [AuthController],
  providers: [AuthService, JwtStrategy, FeishuStrategy],
  exports: [AuthService],
})
export class AuthModule { }
```

å°† `JwtModule` åœ¨ `AuthModule` ä¸­æ³¨å†Œï¼Œå¹¶å°†å…¶ä»–çš„ `Controller`ã€`Services` ç­‰éƒ½å¯¼å…¥ï¼Œæœ€åè®°å¾—å°† `AuthModule` å¯¼å…¥ `app.module.ts`ã€‚

`/src/auth/constants.ts` çš„å†…å®¹å¦‚ä¸‹ï¼š

```
import { SetMetadata } from '@nestjs/common';

export const jwtConstants = {
  secret: 'yyds', // ç§˜é’¥ï¼Œä¸å¯¹å¤–å…¬å¼€ã€‚
  expiresIn: '15s', // æ—¶æ•ˆæ—¶é•¿
  ignoreExpiration: true, // æ˜¯å¦å¿½ç•¥ token æ—¶æ•ˆ
};

export const IS_PUBLIC_KEY = 'isPublic';

export const Public = () => SetMetadata(IS_PUBLIC_KEY, true);
```

å°†é£ä¹¦åº”ç”¨å¯¹æ¥ä¸­è·å–çš„ä¸´æ—¶ç™»å½•å‡­è¯å¡«å…¥ `Swagger` æµ‹è¯•æ¥å£ä¸­æ‰§è¡Œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ`JWT Token` å·²ç»æ­£å¸¸è¿”å›äº†ï¼Œå¹¶ä¸”è¢« `NestJS` åç«¯æ³¨å…¥åˆ° `cookie` ä¸­ï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d3c0c63fde7340768c588847f4e3e0d9~tplv-k3u1fbpfcp-watermark.image?)

**ç¬¬ä¸ƒæ­¥**ï¼šä¸€èˆ¬æ¥è¯´ï¼Œç™»å½•æƒé™éœ€è¦å…¨å±€å¼€å¯ï¼Œåªæœ‰å°‘éƒ¨åˆ†çš„æ¥å£é€šè¿‡ç™½åå•å¼€æ”¾ç»™å¤–éƒ¨ä½¿ç”¨ï¼Œæ‰€ä»¥éœ€è¦å°† `JWT` çš„è‡ªå®šä¹‰è·¯ç”±æŒ‚è½½åˆ°å…¨å±€ï¼Œä¿®æ”¹ `app.module.ts`ï¼Œæ·»åŠ å…¨å±€ `APP_GUARD` æ¨¡å—ã€‚

```js
import { APP_GUARD } from '@nestjs/core';

@Module({
  imports: [
    CacheModule.register({
      isGlobal: true,
      store: redisStore,
      host: getConfig('REDIS_CONFIG').host,
      port: getConfig('REDIS_CONFIG').port,
      auth_pass: getConfig('REDIS_CONFIG').auth,
      db: getConfig('REDIS_CONFIG').db
    }),
    ConfigModule.forRoot({
      ignoreEnvFile: true,
      isGlobal: true,
      load: [getConfig]
    }),
    AuthModule,
    PageModule
  ],
  controllers: [],
  providers: [
    {
      provide: APP_GUARD,
      useClass: JwtAuthGuard,
    },
  ],
})
```

åœ¨æ­£å¸¸å†™å…¥ `JWT Token` ä»¥åŠæ·»åŠ å…¨å±€ `JWT` è·¯ç”±æ‹¦æˆªåï¼Œå¯ä»¥é€šè¿‡ `Swagger` ä¸­çš„ `/token/info` æ¥å£æ¥æµ‹è¯•æ˜¯å¦èƒ½æ­£å¸¸è§£æ `token` çš„ä¿¡æ¯ï¼Œå¦‚æœä¸€åˆ‡æ­£å¸¸çš„è¯ï¼Œåˆ™å‡ºç°å¦‚ä¸‹å›¾ç•Œé¢ï¼š

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0b4c6feb3cb24695827ad5b0bd64ecc7~tplv-k3u1fbpfcp-watermark.image?)

## å†™åœ¨æœ€å

æœ¬ç« ä¸»è¦ä»‹ç»äº†å¦‚ä½•åˆ©ç”¨é£ä¹¦çš„ä¸‰æ–¹æ¥å£ä»¥åŠ `NestJS` æä¾›çš„ `Guards` èƒ½åŠ›ï¼Œä½¿ç”¨ `Passport` ä¸ `JWT` æ¥å®Œæˆç¬¬ä¸‰æ–¹åº”ç”¨æˆæƒçš„åŠŸèƒ½ï¼Œå‡å°‘ç”¨æˆ·çš„ä½¿ç”¨æˆæœ¬ã€‚

å…¶ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº† `Guards` æ¨¡å—ã€`Passport` ä»¥åŠ `JWT` çš„ç›¸å…³çŸ¥è¯†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥ä¸å…¶ä»–çš„æ¡†æ¶å¦‚ `Egg` çš„æ¥å…¥åšä¸€ä¸ªå¯¹æ¯”ï¼Œ**è®¾è®¡ç†å¿µ**ä¸**ä»£ç ç¼–å†™**çš„ä¸åŒå¯ä»¥ä»ç™»å½•åŠŸèƒ½çš„å®ç°ä¸­æ·±åˆ»ä½“ä¼šåˆ°ã€‚

å¦å¤–ï¼Œæœ¬ç« å¹¶æœªè¿‡å¤šçš„ä»‹ç» `Guards` æ¨¡å—ï¼Œ`NestJS` æºæ–‡æ¡£å¯¹æ­¤çš„æè¿°å·²ç»è¶³å¤Ÿå®Œå¤‡ï¼Œæƒ³è¦äº†è§£æ›´å¤šçš„ç»†èŠ‚æˆ–è€…è®¾è®¡å¯ä»¥å»æºæ–‡æ¡£ç›´æ¥æŸ¥é˜…ï¼Œä½œä¸ºå®æˆ˜ç±»å‹çš„å°å†Œï¼Œæœ¬ç« ä¹‹åçš„ä¸»ä½“å†…å®¹å°†èšç„¦åœ¨å¦‚ä½•å®Œæˆä¸šåŠ¡å¼€å‘ä¸Šï¼Œä¸ä¼šå†é’ˆå¯¹æŸä¸€ä¸ªæ¨¡å—åŠŸèƒ½åšæ›´è¯¦ç»†çš„è§£é‡Šã€‚

å¦‚æœä½ æœ‰ä»€ä¹ˆç–‘é—®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºæå‡ºæˆ–è€…åŠ ç¾¤æ²Ÿé€šã€‚ ğŸ‘
    