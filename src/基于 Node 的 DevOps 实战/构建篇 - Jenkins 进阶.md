
# æ„å»ºç¯‡ - Jenkins è¿›é˜¶
---

## å‰è¨€

ä¸Šä¸€ç« æ˜¯ Docker çš„ä¸€äº›åŸºç¡€ç”¨æ³•ï¼Œ å¹¶ä¸”æˆ‘ä»¬å·²ç»é€šè¿‡ Docker æ„å»ºäº†ä¸€ä¸ªä¸“é—¨ç”¨äºæ‰“åŒ…çš„ Docker é•œåƒï¼Œé‚£ä¹ˆæœ¬ç« ï¼Œæœ¬å°†å€ŸåŠ© Jenkins çš„ pipeline æµæ°´çº¿ï¼Œæ„å»ºä¸€å¥—é€‚é…å¤šç«¯çš„ jobã€‚

## æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡

ç…§ä¾‹ï¼Œåœ¨æ­£å¼å¼€å‘ä¹‹å‰è¿›è¡Œäº†ä¸€è½®æŠ€æœ¯é¢„ç ”ï¼Œå…ˆå°†é¢„ç ”çš„æ–¹æ¡ˆç†ä¸€ä¸‹

#### è„šæœ¬å…¨é‡æµç¨‹ + when æ¡ä»¶

ä¸€ä¸ª pineline æµæ°´çº¿å°†æ‰€æœ‰çš„çŠ¶æ€æµç¨‹éƒ½æ˜¯é¢„è®¾å¥½çš„ï¼Œä¾‹å¦‚å…¨é‡çš„æµç¨‹ä» dev \-> test \-> deploy è¿™ç§ï¼Œå¯ä»¥é€šè¿‡å‚æ•° + when æ¡ä»¶è¯­å¥è·³è¿‡æŒ‡å®šæµç¨‹

ä¼˜åŠ¿ï¼š

è¿™ä¸ªæ–¹æ¡ˆæ˜¯æœ€ç®€å•çš„ï¼ŒåŒæ—¶å¼€å‘æˆæœ¬æœ€ä½ã€‚

åŠ£åŠ¿ï¼š

è™½ç„¶æ˜¯ç®€å•çš„æ–¹æ¡ˆï¼Œä½†æ˜¯è„šæœ¬ç›¸å¯¹äºå›ºå®šï¼Œå¦‚æœæœ‰å…¨æ–°çš„æµç¨‹æ˜¯éœ€è¦é‡æ–°å¼€å‘æ–°çš„ pipeline æµæ°´çº¿ã€‚

#### pipeline scm

é€šè¿‡ pipeline scm åœ¨æ‹‰å– git é¡¹ç›®çš„åŒæ—¶è¯»å– git é¡¹ç›®ä¸­çš„é…ç½®æ–‡ä»¶ï¼ˆJenkinsfileï¼‰ï¼Œè¿›è¡Œé¡¹ç›®æ„å»ºã€‚

ä¼˜åŠ¿ï¼š

ç›¸æ¯”ç¬¬ä¸€ç§æ¯”è¾ƒçµæ´»ï¼Œåœ¨é¡¹ç›®æ„å»ºä¹‹å‰é€šè¿‡ gitlab api çš„æ–¹å¼å»ä¿®æ”¹ Jenkinsfileï¼Œè¾¾åˆ°ä¸€ä¸ªåŠ¨æ€ç”Ÿæˆæµæ°´çº¿çš„ç›®çš„ã€‚

åŠ£åŠ¿ï¼š

éœ€è¦é€šè¿‡ gitlab api å»ä¿®æ”¹ Jenkinsfileï¼Œå®¹æ˜“å¼•èµ·å†²çªã€‚

#### ä¿®æ”¹ Jenkinsfile

åˆ›å»º 10 ä¸ª jobï¼Œå…³é—­å• job çš„å¹¶å‘åŠŸèƒ½ï¼Œç›´æ¥é€šè¿‡ Jenkins Api ä¿®æ”¹å¯¹åº”çš„ Jenkinsfileï¼Œç„¶åæ‰‹åŠ¨ç»´æŠ¤ä»»åŠ¡é˜Ÿåˆ—ã€‚

ä¼˜åŠ¿ï¼š

è‡ªå®šä¹‰åŒ–ç¨‹åº¦éå¸¸é«˜ï¼Œä¸”ä¸é¡¹ç›®ä»£ç å®Œå…¨éš”ç¦»ï¼Œä¸éœ€è¦ä¿®æ”¹é¡¹ç›®ä¸­çš„é…ç½®æ–‡ä»¶ã€‚

åŠ£åŠ¿ï¼š

Jenkins çš„ job è‡ªå¸¦å¹¶å‘é˜Ÿåˆ—ï¼Œæ‰‹åŠ¨ç»´æŠ¤é˜Ÿåˆ—å¢åŠ å¼€å‘æˆæœ¬ã€‚

#### blue ocean

ä½¿ç”¨ blue ocean å…³è”æºç ä»“åº“ï¼Œä¿®æ”¹ Jenkinsfile å†è¿è¡Œï¼Œè¿™ç§æ–¹æ¡ˆä¸ç¬¬äºŒç§è™½ç„¶è¿‡ç¨‹ä¸åŒä½†ç»“æœåŸºæœ¬ç±»ä¼¼ï¼Œæ‰€ä»¥ä¼˜ç¼ºç‚¹åŸºæœ¬ç›¸é€š

#### æœ€åæ–¹æ¡ˆ

æ ¹æ®ä¸Šè¿° 4 ä¸ªæ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹ï¼Œç»“åˆç°æœ‰çš„äººåŠ›å¯ä»¥é’ˆå¯¹æ€§çš„é€‰æ‹©ï¼Œé‚£ä¹ˆå¯¹æˆ‘ä»¬æ¥è¯´ï¼Œç¬¬ä¸€ç§æ–¹æ¡ˆçš„æ€§ä»·æ¯”æ˜¯æœ€é«˜çš„ã€‚

## Jenkinsfile

é€‰å®šæ–¹æ¡ˆä¹‹åï¼Œæˆ‘ä»¬å°±éœ€è¦å¼€å‘å¯¹åº”çš„ pipeline è„šæœ¬äº†ã€‚

> è¿™é‡Œä¹Ÿä¸è¿‡å¤šä»‹ç»è¯­æ³•çš„è¯¦ç»†ï¼Œæƒ³è¦äº†è§£æ›´å¤šçš„åŒå­¦ä»¬å¯ä»¥ç‚¹å‡» [API æ–‡æ¡£](https://www.jenkins.io/zh/doc/book/pipeline/syntax/)åœ°å€æŸ¥çœ‹æ›´å¤š

#### åˆ›å»º stage

é¦–å…ˆåˆ›å»ºå…¨é‡ stage

```
pipeline {
    agent any 
    stages {
        stage('Pre Git') {
            steps {
                script {
                    echo "pre git"
                }
            }
        }
        stage('Pre Dependencies') {
            steps {
                script {
                    echo "check node_modules,${params.CACHE}"
                }
            }
        }
        stage('build') {
            steps {
                script {
                    echo "build project"
                }
            }
        }
        stage('test') {
            steps {
                script {
                    echo "test case"
                }
            }
        }
        stage('deploy') {
            steps {
                script {
                    echo "deploy project"
                }
            }
        }
    }
```

å¦‚ä¸Šï¼Œæˆ‘ä»¬åˆ›å»ºäº† 5 ä¸ª stageï¼š

- Pre Gitï¼šæ‹‰å–é¡¹ç›®
- Pre Dependenciesï¼šå®‰è£…ä¾èµ–
- buildï¼šæ„å»º
- testï¼šæµ‹è¯•
- deploy: å‘å¸ƒ

#### Pre Git æ‹‰å–é¡¹ç›®

æ‹‰å–é¡¹ç›®åˆ†ä¸¤ç§

 1.     é¡¹ç›®æœªæ‹‰å–ï¼Œè¿™ç§æƒ…å†µå¾ˆç®€å•ï¼Œç›´æ¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å³å¯ï¼š

```js
sh "git clone ${params.PROJECT_GIT_PATH}"
sh "git checkout ${params.BRANCH_NAME}"
```

2.  é¡¹ç›®å·²å­˜åœ¨

å¦‚æœé¡¹ç›®å·²ç»è¢« clone è¿‡äº†ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½åœ¨å®‰è£…ä¾èµ–çš„ä¹‹åï¼Œæ‹‰å–åˆ‡æ¢åˆ†æ”¯å‡ºç°å†²çªï¼Œæˆ–è€…åˆ†æ”¯åˆ é™¤å¯¼è‡´æ‹‰å–å¼‚å¸¸ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦é‡ç½®æœ¬åœ° git

```
 sh "git fetch --all"
sh "git reset --hard origin/${params.BRANCH_NAME}"
sh "git checkout ${params.BRANCH_NAME}"
```

#### Pre Dependencies å®‰è£…ä¾èµ–

è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ç®€å•çš„ yarn å‘½ä»¤ï¼Œæ‰€æœ‰é¡¹ç›®ç›´æ¥ä½¿ç”¨ yarnï¼Œä¾é  yarn æœ¬èº«çš„å±æ€§å¸®æˆ‘ä»¬ç¼“å­˜ + æ ¡æ­£ä¾èµ–ã€‚

#### build æ„å»ºé¡¹ç›®

è¿™ä¸€æ­¥å°±å¯ä»¥ä½¿ç”¨åˆ°æˆ‘ä»¬ä¸Šä¸€ç« æ„å»ºå¥½çš„æ‰“åŒ…é•œåƒ

```js
sh "docker run -i --rm \
-v /home/build/${params.PROJECT_NAME}:/home/${params.PROJECT_NAME} \
${params.DOCKER_PUBLISHER} sh -c \
'cd /home/app && CONFIG_PATH=/home/${params.PROJECT_NAME}/.config.json node ./src/build.js  && exit'"
```

æ•´ä½“çš„æµç¨‹æ˜¯æ ¹æ®ä¼ å…¥çš„ docker é•œåƒåç§°ï¼Œæ‹‰å–å¯¹åº”çš„é•œåƒï¼Œå°†æœ¬åœ°çš„é¡¹ç›®è·¯å¾„æŒ‚è½½åˆ° docker å½“ä¸­ï¼Œç„¶åå†åœ¨ docker ä¸­è¿›è¡Œé¡¹ç›®æ„å»ºã€‚

è¿™æ ·çš„ä¼˜åŠ¿è¿˜æ˜¯ä¸é”™çš„ï¼Œè¿™é‡Œé‡ç”³ä¸€ä¸‹ï¼š

1.  docker æ˜¯**ç¯å¢ƒéš”ç¦»**çš„ï¼Œè¿™æ ·å¦‚æœå‡ºç°éæ³•æŒ‡ä»¤æˆ–è€…å¼‚å¸¸ï¼Œå´©æ‰çš„åªæ˜¯å½“å‰å®¹å™¨ï¼Œè€Œä¸ä¼šå½±å“å®¿ä¸»ç³»ç»Ÿï¼Œæœ€å¤šå½±å“åˆ°å½“å‰æŒ‚è½½åˆ° docker çš„é¡¹ç›®
2.  åŒæ—¶å¾—ç›Šäºç¯å¢ƒéš”ç¦»ï¼Œdocker æ„å»ºå‡ºæ¥çš„æ‰“åŒ…é•œåƒæ˜¯ä»»æ„çš„ï¼Œä¹Ÿå°±æ˜¯å®ƒå¯ä»¥**ä¸ºæ‰€æ¬²ä¸º**ã€‚æ„å»ºç¯å¢ƒä¸å‘½ä»¤éƒ½æ˜¯è‡ªå®šä¹‰çš„ï¼Œå€ŸåŠ©è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬ç³»ç»Ÿæ„å»ºçš„é¡¹ç›®å°†ä¸ä¸ä»…ä»…é™åˆ¶äºå‰ç«¯é¡¹ç›®ã€‚

#### deploy å‘å¸ƒé¡¹ç›®

ä¸æ„å»ºç›¸é€šï¼Œå¯¹äºå‘å¸ƒæ¥è¯´ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ docker æ¥è§£å†³ï¼Œå› ä¸ºæ¯ä¸ªé¡¹ç›®çš„å‘å¸ƒåœ°å€ã€æ–¹å¼å¯ä»¥ä¸å°½ç›¸åŒã€‚

```js
sh "docker run -i --rm \
-v /home/build/${params.PROJECT_NAME}:/home/${params.PROJECT_NAME} \
${params.DOCKER_PUBLISHER} sh -c \
'cd /home/app && CONFIG_PATH=/home/${params.PROJECT_NAME}/.config.json node ./src/build.js  && exit'"
```

æ‰€ä»¥ä¸Šè¿°çš„å‘½ä»¤éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå¯ä»¥ç”±å¤šä¸ªä»»æ„çš„ builder ä¸ publisher docker é•œåƒç»„åˆä½¿ç”¨ã€‚

#### Gitlab ä¿¡æ¯åŒæ­¥

å¯¹äºæµæ°´çº¿æ¥è¯´ï¼Œå¯ä»¥ä½¿ç”¨ gitlab api è¿›è¡Œæ¶ˆæ¯æ¨é€ï¼Œåœ¨ Jenkinsfile çš„ post è¯­æ³•ä¸­åšæœ€åçš„ä¿¡æ¯åŒæ­¥ã€‚

```js
 post {
    always {
        echo 'æ„å»ºç»“æŸ...'
    }
    success {
        echo 'æ­å–œæ‚¨ï¼Œæ„å»ºæˆåŠŸï¼ï¼ï¼'
        sh "curl --request POST --header \"PRIVATE-TOKEN: ${PRIVATE_TOKEN}\" \"${GITLAB_URL}/api/v4/projects/${PROJECT_ID}/statuses/${COMMITS_ID}?state=success\""
     }
    failure {
        echo 'æŠ±æ­‰ï¼Œæ„å»ºå¤±è´¥ï¼ï¼ï¼'
        sh "curl --request POST --header \"PRIVATE-TOKEN: ${PRIVATE_TOKEN}\" \"${GITLAB_URL}/api/v4/projects/${PROJECT_ID}/statuses/${COMMITS_ID}?state=failed\""
    }
    unstable {
        echo 'è¯¥ä»»åŠ¡å·²ç»è¢«æ ‡è®°ä¸ºä¸ç¨³å®šä»»åŠ¡....'
    }
}
```

#### when è¯­æ³•æ¥å…¥

when è¯­æ³•ä½¿ç”¨æ¯”è¾ƒç®€å•ï¼Œä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼Œåœ¨ stage ä¸­ç›´æ¥æ·»åŠ å¯¹åº”çš„è§„åˆ™å³å¯ã€‚

```js

stage('test') {
    when { expression { return PIPELINE_TEST == true } }
    steps {
        script {
            echo "test case"
        }
    }
}
```

## æœ¬ç« å°ç»“

æœ¬ç« æ˜¯ Jenkins çš„ä¸€ä¸ªè¿›é˜¶ä½¿ç”¨ã€‚

å¯ä»¥çœ‹åˆ°æ•´ä¸ªæ„å»ºæµç¨‹ï¼Œæˆ‘ä»¬åˆç†çš„åˆ©ç”¨äº† docker çš„ç‰¹æ€§ï¼Œæ„å»ºäº†ä¸€ä¸ªé€šç”¨æ€§éå¸¸é«˜çš„è„šæœ¬ï¼Œå¯¹åº”çš„æ„å»ºé…ç½®å¯ä»¥æ”¾åœ¨ devops ç³»ç»Ÿä¸­ç»´æŠ¤ï¼Œé€šè¿‡å¯¹æ¯ä¸ªé¡¹ç›®é…ç½®ä¸åŒçš„ builder ä¸ publisherï¼Œç†è®ºä¸Šå¯ä»¥åšåˆ°æ„å»ºä»»æ„é¡¹ç›®ã€‚

åŒæ—¶ Jenkins è¿˜æœ‰æ›´å¤šçš„é«˜çº§ç”¨æ³•ï¼Œæ¯”å¦‚ä½¿ç”¨ `groovy` è¯­æ³•æ‹“å±• pipeline çš„åŠŸèƒ½ã€blue ocean æ’ä»¶ä»¥åŠæ›´å¤šä¼˜ç§€çš„æ’ä»¶ä½¿ç”¨ï¼Œå¯ä»¥å°è¯•è‡ªå®šä¹‰æ›´é«˜çº§çš„ç”¨æ³•ï¼Œå¦‚æœæƒ³è¦äº†è§£æ›´å¤šçš„è·Ÿå…¶ä»–ç–‘é—®çš„è¯å¯ä»¥æ·»åŠ æˆ‘çš„å¾®ä¿¡ **cookieboty** æˆ–è€…åŠ å…¥ç¾¤ä¸€èµ·äº¤æµã€‚

å¦‚æœä½ æœ‰ä»€ä¹ˆç–‘é—®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºæå‡ºï¼Œæˆ–è€…åŠ ç¾¤æ²Ÿé€šã€‚ ğŸ‘
    